(function(a,c){var b=function(z){if(!(this instanceof b)){return new b(z)}var s=this;var o;var u=[];var f;var v={enable:true,callbackList:[],interval:5};s.init=function(E){s.authenticated=false;f=p();if(E&&E.adapter==="cordova"){o=x("cordova")}else{if(E&&E.adapter==="default"){o=x()}else{if(a.Cordova){o=x("cordova")}else{o=x()}}}if(E){if(typeof E.checkLoginIframe!=="undefined"){v.enable=E.checkLoginIframe}if(E.checkLoginIframeInterval){v.interval=E.checkLoginIframeInterval}if(E.onLoad==="login-required"){s.loginRequired=true}if(E.responseMode){if(E.responseMode==="query"||E.responseMode==="fragment"){s.responseMode=E.responseMode}else{throw"Invalid value for responseMode"}}if(E.flow){switch(E.flow){case"standard":s.responseType="code";break;case"implicit":s.responseType="id_token token";break;case"hybrid":s.responseType="code id_token token";break;default:throw"Invalid value for flow"}s.flow=E.flow}}if(!s.responseMode){s.responseMode="fragment"}if(!s.responseType){s.responseType="code";s.flow="standard"}var F=d();var B=d();B.promise.success(function(){s.onReady&&s.onReady(s.authenticated);F.setSuccess(s.authenticated)}).error(function(G){F.setError(G)});var D=i(z);function C(){var H=function(I){if(!I){G.prompt="none"}s.login(G).success(function(){B.setSuccess()}).error(function(){B.setError()})};var G={};switch(E.onLoad){case"check-sso":if(v.enable){y().success(function(){k().success(function(){H(false)}).error(function(){B.setSuccess()})})}else{H(false)}break;case"login-required":H(true);break;default:throw"Invalid value for onLoad"}}function A(){var G=g(a.location.href);if(G){y();a.history.replaceState({},null,G.newUrl);m(G,B);return}else{if(E){if(E.token||E.refreshToken){t(E.token,E.refreshToken,E.idToken);if(v.enable){y().success(function(){k().success(function(){s.onAuthSuccess&&s.onAuthSuccess();B.setSuccess()}).error(function(){s.onAuthError&&s.onAuthError();if(E.onLoad){C()}else{B.setError()}})})}else{s.updateToken(-1).success(function(){s.onAuthSuccess&&s.onAuthSuccess();B.setSuccess()}).error(function(){s.onAuthError&&s.onAuthError();if(E.onLoad){C()}else{B.setError()}})}}else{if(E.onLoad){C()}else{B.setSuccess()}}}else{B.setSuccess()}}}D.success(A);D.error(function(){F.setError()});return F.promise};s.login=function(A){return o.login(A)};s.createLoginUrl=function(C){var G=e();var E=e();var H=o.redirectUri(C);var A={state:G,nonce:E,redirectUri:encodeURIComponent(H),};if(C&&C.prompt){A.prompt=C.prompt}f.add(A);var F="auth";if(C&&C.action=="register"){F="registrations"}var D=(C&&C.scope)?"openid "+C.scope:"openid";var B=n()+"/protocol/openid-connect/"+F+"?client_id="+encodeURIComponent(s.clientId)+"&redirect_uri="+encodeURIComponent(H)+"&state="+encodeURIComponent(G)+"&nonce="+encodeURIComponent(E)+"&response_mode="+encodeURIComponent(s.responseMode)+"&response_type="+encodeURIComponent(s.responseType)+"&scope="+encodeURIComponent(D);if(C&&C.prompt){B+="&prompt="+encodeURIComponent(C.prompt)}if(C&&C.maxAge){B+="&max_age="+encodeURIComponent(C.maxAge)}if(C&&C.loginHint){B+="&login_hint="+encodeURIComponent(C.loginHint)}if(C&&C.idpHint){B+="&la_idp_hint="+encodeURIComponent(C.idpHint)}if(C&&C.locale){B+="&ui_locales="+encodeURIComponent(C.locale)}return B};s.logout=function(A){return o.logout(A)};s.createLogoutUrl=function(B){var A=n()+"/protocol/openid-connect/logout?redirect_uri="+encodeURIComponent(o.redirectUri(B,false));return A};s.register=function(A){return o.register(A)};s.createRegisterUrl=function(A){if(!A){A={}}A.action="register";return s.createLoginUrl(A)};s.createAccountUrl=function(B){var A=n()+"/account?referrer="+encodeURIComponent(s.clientId)+"&referrer_uri="+encodeURIComponent(o.redirectUri(B));return A};s.accountManagement=function(){return o.accountManagement()};s.hasRealmRole=function(B){var A=s.realmAccess;return !!A&&A.roles.indexOf(B)>=0};s.hasResourceRole=function(C,B){if(!s.resourceAccess){return false}var A=s.resourceAccess[B||s.clientId];return !!A&&A.roles.indexOf(C)>=0};s.loadUserProfile=function(){var A=n()+"/account";var B=new XMLHttpRequest();B.open("GET",A,true);B.setRequestHeader("Accept","application/json");B.setRequestHeader("Authorization","bearer "+s.token);var C=d();B.onreadystatechange=function(){if(B.readyState==4){if(B.status==200){s.profile=JSON.parse(B.responseText);C.setSuccess(s.profile)}else{C.setError()}}};B.send();return C.promise};s.loadUserInfo=function(){var A=n()+"/protocol/openid-connect/userinfo";var B=new XMLHttpRequest();B.open("GET",A,true);B.setRequestHeader("Accept","application/json");B.setRequestHeader("Authorization","bearer "+s.token);var C=d();B.onreadystatechange=function(){if(B.readyState==4){if(B.status==200){s.userInfo=JSON.parse(B.responseText);C.setSuccess(s.userInfo)}else{C.setError()}}};B.send();return C.promise};s.isTokenExpired=function(A){if(!s.tokenParsed||(!s.refreshToken&&s.flow!="implicit")){throw"Not authenticated"}var B=s.tokenParsed.exp-Math.ceil(new Date().getTime()/1000)+s.timeSkew;if(A){B-=A}return B<0};s.updateToken=function(A){var D=d();if(!s.tokenParsed||!s.refreshToken){D.setError();return D.promise}A=A||5;var B=function(){var G=false;if(s.timeSkew==-1){console.info("Skew "+s.timeSkew);G=true;console.info("[LEADSAUTH] Refreshing token: time skew not set")}else{if(A==-1){G=true;console.info("[LEADSAUTH] Refreshing token: forced refresh")}else{if(s.isTokenExpired(A)){G=true;console.info("[LEADSAUTH] Refreshing token: token expired")}}}if(!G){D.setSuccess(false)}else{var I="grant_type=refresh_token&refresh_token="+s.refreshToken;var F=n()+"/protocol/openid-connect/token";u.push(D);if(u.length==1){var H=new XMLHttpRequest();H.open("POST",F,true);H.setRequestHeader("Content-type","application/x-www-form-urlencoded");H.withCredentials=true;if(s.clientId&&s.clientSecret){H.setRequestHeader("Authorization","Basic "+btoa(s.clientId+":"+s.clientSecret))}else{I+="&client_id="+encodeURIComponent(s.clientId)}var E=new Date().getTime();H.onreadystatechange=function(){if(H.readyState==4){if(H.status==200){console.info("[LEADSAUTH] Token refreshed");E=(E+new Date().getTime())/2;var K=JSON.parse(H.responseText);t(K.access_token,K.refresh_token,K.id_token,E);s.onAuthRefreshSuccess&&s.onAuthRefreshSuccess();for(var J=u.pop();J!=null;J=u.pop()){J.setSuccess(true)}}else{console.warn("[LEADSAUTH] Failed to refresh token");s.onAuthRefreshError&&s.onAuthRefreshError();for(var J=u.pop();J!=null;J=u.pop()){J.setError(true)}}}};H.send(I)}}};if(v.enable){var C=k();C.success(function(){B()}).error(function(){D.setError()})}else{B()}return D.promise};s.clearToken=function(){if(s.token){t(null,null,null);s.onAuthLogout&&s.onAuthLogout();if(s.loginRequired){s.login()}}};function n(){if(s.authServerUrl.charAt(s.authServerUrl.length-1)=="/"){return s.authServerUrl+"realms/"+encodeURIComponent(s.realm)}else{return s.authServerUrl+"/realms/"+encodeURIComponent(s.realm)}}function w(){if(!a.location.origin){return a.location.protocol+"//"+a.location.hostname+(a.location.port?":"+a.location.port:"")}else{return a.location.origin}}function m(H,K){var D=H.code;var I=H.error;var E=H.prompt;var C=new Date().getTime();if(I){if(E!="none"){var B={error:I,error_description:H.error_description};s.onAuthError&&s.onAuthError(B);K&&K.setError(B)}else{K&&K.setSuccess()}return}else{if((s.flow!="standard")&&(H.access_token||H.id_token)){G(H.access_token,null,H.id_token,true)}}if((s.flow!="implicit")&&D){var F="code="+D+"&grant_type=authorization_code";var A=n()+"/protocol/openid-connect/token";var J=new XMLHttpRequest();J.open("POST",A,true);J.setRequestHeader("Content-type","application/x-www-form-urlencoded");if(s.clientId&&s.clientSecret){J.setRequestHeader("Authorization","Basic "+btoa(s.clientId+":"+s.clientSecret))}else{F+="&client_id="+encodeURIComponent(s.clientId)}F+="&redirect_uri="+H.redirectUri;J.withCredentials=true;J.onreadystatechange=function(){if(J.readyState==4){if(J.status==200){var L=JSON.parse(J.responseText);G(L.access_token,L.refresh_token,L.id_token,s.flow==="standard")}else{s.onAuthError&&s.onAuthError();K&&K.setError()}}};J.send(F)}function G(L,M,O,N){C=(C+new Date().getTime())/2;t(L,M,O,C);if((s.tokenParsed&&s.tokenParsed.nonce!=H.storedNonce)||(s.refreshTokenParsed&&s.refreshTokenParsed.nonce!=H.storedNonce)||(s.idTokenParsed&&s.idTokenParsed.nonce!=H.storedNonce)){console.info("[LEADSAUTH] Invalid nonce, clearing token");s.clearToken();K&&K.setError()}else{if(N){s.onAuthSuccess&&s.onAuthSuccess();K&&K.setSuccess()}}}}function i(C){var F=d();var B;if(!z){B="leadsauth.json"}else{if(typeof z==="string"){B=z}}if(B){var E=new XMLHttpRequest();E.open("GET",B,true);E.setRequestHeader("Accept","application/json");E.onreadystatechange=function(){if(E.readyState==4){if(E.status==200){var G=JSON.parse(E.responseText);s.authServerUrl=G["auth-server-url"];s.realm=G.realm;s.clientId=G.resource;s.clientSecret=(G.credentials||{})["secret"];F.setSuccess()}else{F.setError()}}};E.send()}else{if(!z.url){var A=document.getElementsByTagName("script");for(var D=0;D<A.length;D++){if(A[D].src.match(/.*leadsauth\.js/)){z.url=A[D].src.substr(0,A[D].src.indexOf("/js/leadsauth.js"));break}}}if(!z.realm){throw"realm missing"}if(!z.clientId){throw"clientId missing"}s.authServerUrl=z.url;s.realm=z.realm;s.clientId=z.clientId;s.clientSecret=(z.credentials||{}).secret;F.setSuccess()}return F.promise}function t(D,C,F,B){if(s.tokenTimeoutHandle){clearTimeout(s.tokenTimeoutHandle);s.tokenTimeoutHandle=null}if(D){s.token=D;s.tokenParsed=q(D);var E=s.realm+"/"+s.tokenParsed.sub;if(s.tokenParsed.session_state){E=E+"/"+s.tokenParsed.session_state}s.sessionId=E;s.authenticated=true;s.subject=s.tokenParsed.sub;s.realmAccess=s.tokenParsed.realm_access;s.resourceAccess=s.tokenParsed.resource_access;if(B){s.timeSkew=Math.floor(B/1000)-s.tokenParsed.iat;console.info("[LEADSAUTH] Estimated time difference between browser and server is "+s.timeSkew+" seconds")}else{s.timeSkew=-1}if(s.onTokenExpired){if(s.timeSkew==-1){s.onTokenExpired()}else{var A=(s.tokenParsed.exp-(new Date().getTime()/1000)+s.timeSkew)*1000;if(A<=0){s.onTokenExpired()}else{s.tokenTimeoutHandle=setTimeout(s.onTokenExpired,A)}}}}else{delete s.token;delete s.tokenParsed;delete s.subject;delete s.realmAccess;delete s.resourceAccess;s.authenticated=false}if(C){s.refreshToken=C;s.refreshTokenParsed=q(C)}else{delete s.refreshToken;delete s.refreshTokenParsed}if(F){s.idToken=F;s.idTokenParsed=q(F)}else{delete s.idToken;delete s.idTokenParsed}}function q(A){A=A.split(".")[1];A=A.replace("/-/g","+");A=A.replace("/_/g","/");switch(A.length%4){case 0:break;case 2:A+="==";break;case 3:A+="=";break;default:throw"Invalid token"}A=(A+"===").slice(0,A.length+(A.length%4));A=A.replace(/-/g,"+").replace(/_/g,"/");A=decodeURIComponent(escape(atob(A)));A=JSON.parse(A);return A}function e(){var D=[];var A="0123456789abcdef";for(var B=0;B<36;B++){D[B]=A.substr(Math.floor(Math.random()*16),1)}D[14]="4";D[19]=A.substr((D[19]&3)|8,1);D[8]=D[13]=D[18]=D[23]="-";var C=D.join("");return C}s.callback_id=0;function r(){var A="<id: "+(s.callback_id++)+(Math.random())+">";return A}function g(B){var A=new j(B,s.responseMode).parseUri();var C=f.get(A.state);if(C&&(A.code||A.error||A.access_token||A.id_token)){A.redirectUri=C.redirectUri;A.storedNonce=C.nonce;A.prompt=C.prompt;if(A.fragment){A.newUrl+="#"+A.fragment}return A}}function d(){var A={setSuccess:function(B){A.success=true;A.result=B;if(A.successCallback){A.successCallback(B)}},setError:function(B){A.error=true;A.result=B;if(A.errorCallback){A.errorCallback(B)}},promise:{success:function(B){if(A.success){B(A.result)}else{if(!A.error){A.successCallback=B}}return A.promise},error:function(B){if(A.error){B(A.result)}else{if(!A.success){A.errorCallback=B}}return A.promise}}};return A}function y(){var E=d();if(!v.enable){E.setSuccess();return E.promise}if(v.iframe){E.setSuccess();return E.promise}var C=document.createElement("iframe");v.iframe=C;C.onload=function(){var F=n();if(F.charAt(0)==="/"){v.iframeOrigin=w()}else{v.iframeOrigin=F.substring(0,F.indexOf("/",8))}E.setSuccess();setTimeout(A,v.interval*1000)};var D=n()+"/protocol/openid-connect/login-status-iframe.html";C.setAttribute("src",D);C.style.display="none";document.body.appendChild(C);var B=function(G){if(G.origin!==v.iframeOrigin){return}if(G.data!="unchanged"){s.clearToken()}for(var F=v.callbackList.length-1;F>=0;--F){var H=v.callbackList[F];if(G.data=="unchanged"){H.setSuccess()}else{H.setError()}v.callbackList.splice(F,1)}};a.addEventListener("message",B,false);var A=function(){k();if(s.token){setTimeout(A,v.interval*1000)}};return E.promise}function k(){var C=d();if(v.iframe&&v.iframeOrigin){var B=s.clientId+" "+s.sessionId;v.callbackList.push(C);var A=v.iframeOrigin;if(v.callbackList.length==1){v.iframe.contentWindow.postMessage(B,A)}}else{C.setSuccess()}return C.promise}function x(A){if(!A||A=="default"){return{login:function(B){a.location.href=s.createLoginUrl(B);return d().promise},logout:function(B){a.location.href=s.createLogoutUrl(B);return d().promise},register:function(B){a.location.href=s.createRegisterUrl(B);return d().promise},accountManagement:function(){a.location.href=s.createAccountUrl();return d().promise},redirectUri:function(B,C){if(arguments.length==1){C=true}if(B&&B.redirectUri){return B.redirectUri}else{if(s.redirectUri){return s.redirectUri}else{var D=location.href;if(location.hash&&C){D=D.substring(0,location.href.indexOf("#"));D+=(D.indexOf("?")==-1?"?":"&")+"redirect_fragment="+encodeURIComponent(location.hash.substring(1))}return D}}}}}if(A=="cordova"){v.enable=false;return{login:function(B){var G=d();var F="location=no";if(B&&B.prompt=="none"){F+=",hidden=yes"}var E=s.createLoginUrl(B);var D=a.open(E,"_blank",F);var C=false;D.addEventListener("loadstart",function(H){if(H.url.indexOf("http://localhost")==0){var I=g(H.url);m(I,G);D.close();C=true}});D.addEventListener("loaderror",function(H){if(!C){if(H.url.indexOf("http://localhost")==0){var I=g(H.url);m(I,G);D.close();C=true}else{G.setError();D.close()}}});return G.promise},logout:function(D){var F=d();var B=s.createLogoutUrl(D);var E=a.open(B,"_blank","location=no,hidden=yes");var C;E.addEventListener("loadstart",function(G){if(G.url.indexOf("http://localhost")==0){E.close()}});E.addEventListener("loaderror",function(G){if(G.url.indexOf("http://localhost")==0){E.close()}else{C=true;E.close()}});E.addEventListener("exit",function(G){if(C){F.setError()}else{s.clearToken();F.setSuccess()}});return F.promise},register:function(){var B=s.createRegisterUrl();var C=a.open(B,"_blank","location=no");C.addEventListener("loadstart",function(D){if(D.url.indexOf("http://localhost")==0){C.close()}})},accountManagement:function(){var B=s.createAccountUrl();var C=a.open(B,"_blank","location=no");C.addEventListener("loadstart",function(D){if(D.url.indexOf("http://localhost")==0){C.close()}})},redirectUri:function(B){return"http://localhost"}}}throw"invalid adapter type: "+A}var l=function(){if(!(this instanceof l)){return new l()}localStorage.setItem("la-test","test");localStorage.removeItem("la-test");var A=this;function B(){var H=new Date().getTime();for(var E=0;E<localStorage.length;E++){var D=localStorage.key(E);if(D&&D.indexOf("la-callback-")==0){var G=localStorage.getItem(D);if(G){try{var C=JSON.parse(G).expires;if(!C||C<H){localStorage.removeItem(D)}}catch(F){localStorage.removeItem(D)}}}}}A.get=function(E){if(!E){return}var C="la-callback-"+E;var D=localStorage.getItem(C);if(D){localStorage.removeItem(C);D=JSON.parse(D)}B();return D};A.add=function(D){B();var C="la-callback-"+D.state;D.expires=new Date().getTime()+(60*60*1000);localStorage.setItem(C,JSON.stringify(D))}};var h=function(){if(!(this instanceof h)){return new h()}var C=this;C.get=function(F){if(!F){return}var E=A("la-callback-"+F);B("la-callback-"+F,"",D(-100));if(E){return JSON.parse(E)}};C.add=function(E){B("la-callback-"+E.state,JSON.stringify(E),D(60))};C.removeItem=function(E){B(E,"",D(-100))};var D=function(E){var F=new Date();F.setTime(F.getTime()+(E*60*1000));return F};var A=function(H){var F=H+"=";var E=document.cookie.split(";");for(var G=0;G<E.length;G++){var I=E[G];while(I.charAt(0)==" "){I=I.substring(1)}if(I.indexOf(F)==0){return I.substring(F.length,I.length)}}return""};var B=function(G,H,E){var F=G+"="+H+"; expires="+E.toUTCString()+"; ";document.cookie=F}};function p(){try{return new l()}catch(A){}return new h()}var j=function(A,D){if(!(this instanceof j)){return new j(A,D)}var F=this;var B=function(){var J=null;var K=null;var I=null;var G=A.indexOf("?");var H=A.indexOf("#",G+1);if(G==-1&&H==-1){J=A}else{if(G!=-1){J=A.substring(0,G);K=A.substring(G+1);if(H!=-1){H=K.indexOf("#");I=K.substring(H+1);K=K.substring(0,H)}}else{J=A.substring(0,H);I=A.substring(H+1)}}return{baseUri:J,queryString:K,fragmentString:I}};var C=function(M){var G={};var L=M.split("&");for(var H=0;H<L.length;H++){var J=L[H].split("=");var I=decodeURIComponent(J[0]);var K=decodeURIComponent(J[1]);G[I]=K}return G};var E=function(J,K,G){var I=["code","state","error","error_description"];for(var H=0;H<I.length;H++){if(J===I[H]){G[J]=K;return true}}return false};F.parseUri=function(){var K=B();var I={};if(K.queryString){I=C(K.queryString)}var G={newUrl:K.baseUri};for(var J in I){switch(J){case"redirect_fragment":G.fragment=I[J];break;default:if(D!="query"||!E(J,I[J],G)){G.newUrl+=(G.newUrl.indexOf("?")==-1?"?":"&")+J+"="+I[J]}break}}if(D==="fragment"){var H={};if(K.fragmentString){H=C(K.fragmentString)}for(var J in H){G[J]=H[J]}}return G}}};if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=b}else{a.LeadsAuth=b;if(typeof define==="function"&&define.amd){define("leadsauth",[],function(){return b})}}})(window);