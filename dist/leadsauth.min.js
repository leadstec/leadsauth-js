(function(b,c){var a=function(x){if(!(this instanceof a)){return new a(x)}var w=this;var l;var p=[];var q;var r={enable:true,callbackMap:[],interval:5};w.init=function(C){w.authenticated=false;q=new u();if(C&&C.adapter==="cordova"){l=t("cordova")}else{if(C&&C.adapter==="default"){l=t()}else{if(b.Cordova){l=t("cordova")}else{l=t()}}}if(C){if(typeof C.checkLoginIframe!=="undefined"){r.enable=C.checkLoginIframe}if(C.checkLoginIframeInterval){r.interval=C.checkLoginIframeInterval}if(C.onLoad==="login-required"){w.loginRequired=true}if(C.responseMode){if(C.responseMode==="query"||C.responseMode==="fragment"){w.responseMode=C.responseMode}else{throw"Invalid value for responseMode"}}if(C.flow){switch(C.flow){case"standard":w.responseType="code";break;case"implicit":w.responseType="id_token token";break;case"hybrid":w.responseType="code id_token token";break;default:throw"Invalid value for flow"}w.flow=C.flow}}if(!w.responseMode){w.responseMode="fragment"}if(!w.responseType){w.responseType="code";w.flow="standard"}var D=d();var z=d();z.promise.success(function(){w.onReady&&w.onReady(w.authenticated);D.setSuccess(w.authenticated)}).error(function(){D.setError()});var B=g(x);function A(){var F=function(G){if(!G){E.prompt="none"}w.login(E).success(function(){z.setSuccess()}).error(function(){z.setError()})};var E={};switch(C.onLoad){case"check-sso":if(r.enable){v().success(function(){i().success(function(){F(false)}).error(function(){z.setSuccess()})})}else{F(false)}break;case"login-required":F(true);break;default:throw"Invalid value for onLoad"}}function y(){var E=f(b.location.href);if(E){v();b.history.replaceState({},null,E.newUrl);j(E,z);return}else{if(C){if(C.token||C.refreshToken){o(C.token,C.refreshToken,C.idToken,false);w.timeSkew=C.timeSkew||0;if(r.enable){v().success(function(){i().success(function(){z.setSuccess()}).error(function(){if(C.onLoad){A()}})})}else{z.setSuccess()}}else{if(C.onLoad){A()}else{z.setSuccess()}}}else{z.setSuccess()}}}B.success(y);B.error(function(){D.setError()});return D.promise};w.login=function(y){return l.login(y)};w.createLoginUrl=function(z){var C=e();var A=e();var D=l.redirectUri(z);if(z&&z.prompt){D+=(D.indexOf("?")==-1?"?":"&")+"prompt="+z.prompt}q.setItem("oauthState",JSON.stringify({state:C,nonce:A,redirectUri:encodeURIComponent(D)}));var B="auth";if(z&&z.action=="register"){B="registrations"}var y=k()+"/protocol/openid-connect/"+B+"?client_id="+encodeURIComponent(w.clientId)+"&redirect_uri="+encodeURIComponent(D)+"&state="+encodeURIComponent(C)+"&nonce="+encodeURIComponent(A)+"&response_mode="+encodeURIComponent(w.responseMode)+"&response_type="+encodeURIComponent(w.responseType);if(z&&z.prompt){y+="&prompt="+encodeURIComponent(z.prompt)}if(z&&z.loginHint){y+="&login_hint="+encodeURIComponent(z.loginHint)}if(z&&z.idpHint){y+="&kc_idp_hint="+encodeURIComponent(z.idpHint)}if(z&&z.scope){y+="&scope="+encodeURIComponent(z.scope)}if(z&&z.locale){y+="&ui_locales="+encodeURIComponent(z.locale)}return y};w.logout=function(y){return l.logout(y)};w.createLogoutUrl=function(z){var y=k()+"/protocol/openid-connect/logout?redirect_uri="+encodeURIComponent(l.redirectUri(z,false));return y};w.register=function(y){return l.register(y)};w.createRegisterUrl=function(y){if(!y){y={}}y.action="register";return w.createLoginUrl(y)};w.createAccountUrl=function(z){var y=k()+"/account?referrer="+encodeURIComponent(w.clientId)+"&referrer_uri="+encodeURIComponent(l.redirectUri(z));return y};w.accountManagement=function(){return l.accountManagement()};w.hasRealmRole=function(z){var y=w.realmAccess;return !!y&&y.roles.indexOf(z)>=0};w.hasResourceRole=function(A,z){if(!w.resourceAccess){return false}var y=w.resourceAccess[z||w.clientId];return !!y&&y.roles.indexOf(A)>=0};w.loadUserProfile=function(){var y=k()+"/account";var z=new XMLHttpRequest();z.open("GET",y,true);z.setRequestHeader("Accept","application/json");z.setRequestHeader("Authorization","bearer "+w.token);var A=d();z.onreadystatechange=function(){if(z.readyState==4){if(z.status==200){w.profile=JSON.parse(z.responseText);A.setSuccess(w.profile)}else{A.setError()}}};z.send();return A.promise};w.loadUserInfo=function(){var y=k()+"/protocol/openid-connect/userinfo";var z=new XMLHttpRequest();z.open("GET",y,true);z.setRequestHeader("Accept","application/json");z.setRequestHeader("Authorization","bearer "+w.token);var A=d();z.onreadystatechange=function(){if(z.readyState==4){if(z.status==200){w.userInfo=JSON.parse(z.responseText);A.setSuccess(w.userInfo)}else{A.setError()}}};z.send();return A.promise};w.isTokenExpired=function(y){if(!w.tokenParsed||(!w.refreshToken&&w.flow!="implicit")){throw"Not authenticated"}var z=w.tokenParsed.exp-(new Date().getTime()/1000)+w.timeSkew;if(y){z-=y}return z<0};w.updateToken=function(y){var B=d();if(!w.tokenParsed||!w.refreshToken){B.setError();return B.promise}y=y||5;var z=function(){if(!w.isTokenExpired(y)){B.setSuccess(false)}else{var F="grant_type=refresh_token&refresh_token="+w.refreshToken;var D=k()+"/protocol/openid-connect/token";p.push(B);if(p.length==1){var E=new XMLHttpRequest();E.open("POST",D,true);E.setRequestHeader("Content-type","application/x-www-form-urlencoded");if(w.clientId&&w.clientSecret){E.setRequestHeader("Authorization","Basic "+btoa(w.clientId+":"+w.clientSecret))}else{F+="&client_id="+encodeURIComponent(w.clientId)}var C=new Date().getTime();E.onreadystatechange=function(){if(E.readyState==4){if(E.status==200){C=(C+new Date().getTime())/2;var H=JSON.parse(E.responseText);o(H.access_token,H.refresh_token,H.id_token,true);w.timeSkew=Math.floor(C/1000)-w.tokenParsed.iat;w.onAuthRefreshSuccess&&w.onAuthRefreshSuccess();for(var G=p.pop();G!=null;G=p.pop()){G.setSuccess(true)}}else{w.onAuthRefreshError&&w.onAuthRefreshError();for(var G=p.pop();G!=null;G=p.pop()){G.setError(true)}}}};E.send(F)}}};if(r.enable){var A=i();A.success(function(){z()}).error(function(){B.setError()})}else{z()}return B.promise};w.clearToken=function(){if(w.token){o(null,null,null,true);w.onAuthLogout&&w.onAuthLogout();if(w.loginRequired){w.login()}}};function k(){if(w.authServerUrl.charAt(w.authServerUrl.length-1)=="/"){return w.authServerUrl+"realms/"+encodeURIComponent(w.realm)}else{return w.authServerUrl+"/realms/"+encodeURIComponent(w.realm)}}function s(){if(!b.location.origin){return b.location.protocol+"//"+b.location.hostname+(b.location.port?":"+b.location.port:"")}else{return b.location.origin}}function j(E,H){var A=E.code;var F=E.error;var B=E.prompt;var z=new Date().getTime();if(F){if(B!="none"){w.onAuthError&&w.onAuthError();H&&H.setError()}else{H&&H.setSuccess()}return}else{if((w.flow!="standard")&&(E.access_token||E.id_token)){D(E.access_token,null,E.id_token,true)}}if((w.flow!="implicit")&&A){var C="code="+A+"&grant_type=authorization_code";var y=k()+"/protocol/openid-connect/token";var G=new XMLHttpRequest();G.open("POST",y,true);G.setRequestHeader("Content-type","application/x-www-form-urlencoded");if(w.clientId&&w.clientSecret){G.setRequestHeader("Authorization","Basic "+btoa(w.clientId+":"+w.clientSecret))}else{C+="&client_id="+encodeURIComponent(w.clientId)}C+="&redirect_uri="+E.redirectUri;G.withCredentials=true;G.onreadystatechange=function(){if(G.readyState==4){if(G.status==200){var I=JSON.parse(G.responseText);D(I.access_token,I.refresh_token,I.id_token,w.flow==="standard")}else{w.onAuthError&&w.onAuthError();H&&H.setError()}}};G.send(C)}function D(I,J,L,K){z=(z+new Date().getTime())/2;o(I,J,L,true);if((w.tokenParsed&&w.tokenParsed.nonce!=E.storedNonce)||(w.refreshTokenParsed&&w.refreshTokenParsed.nonce!=E.storedNonce)||(w.idTokenParsed&&w.idTokenParsed.nonce!=E.storedNonce)){console.log("invalid nonce!");w.clearToken();H&&H.setError()}else{w.timeSkew=Math.floor(z/1000)-w.tokenParsed.iat;if(K){w.onAuthSuccess&&w.onAuthSuccess();H&&H.setSuccess()}}}}function g(A){var D=d();var z;if(!x){z="leadsid.json"}else{if(typeof x==="string"){z=x}}if(z){var C=new XMLHttpRequest();C.open("GET",z,true);C.setRequestHeader("Accept","application/json");C.onreadystatechange=function(){if(C.readyState==4){if(C.status==200){var E=JSON.parse(C.responseText);w.authServerUrl=E["auth-server-url"];w.realm=E.realm;w.clientId=E.resource;w.clientSecret=(E.credentials||{})["secret"];D.setSuccess()}else{D.setError()}}};C.send()}else{if(!x.url){var y=document.getElementsByTagName("script");for(var B=0;B<y.length;B++){if(y[B].src.match(/.*leadsid\.js/)){x.url=y[B].src.substr(0,y[B].src.indexOf("/js/leadsid.js"));break}}}if(!x.realm){throw"realm missing"}if(!x.clientId){throw"clientId missing"}w.authServerUrl=x.url;w.realm=x.realm;w.clientId=x.clientId;w.clientSecret=(x.credentials||{}).secret;D.setSuccess()}return D.promise}function o(B,A,E,y){if(w.tokenTimeoutHandle){clearTimeout(w.tokenTimeoutHandle);w.tokenTimeoutHandle=null}if(B){w.token=B;w.tokenParsed=m(B);var C=w.realm+"/"+w.tokenParsed.sub;if(w.tokenParsed.session_state){C=C+"/"+w.tokenParsed.session_state}w.sessionId=C;w.authenticated=true;w.subject=w.tokenParsed.sub;w.realmAccess=w.tokenParsed.realm_access;w.resourceAccess=w.tokenParsed.resource_access;if(w.onTokenExpired){var D=y?w.tokenParsed.iat:(new Date().getTime()/1000);var z=w.tokenParsed.exp-D;w.tokenTimeoutHandle=setTimeout(w.onTokenExpired,z*1000)}}else{delete w.token;delete w.tokenParsed;delete w.subject;delete w.realmAccess;delete w.resourceAccess;w.authenticated=false}if(A){w.refreshToken=A;w.refreshTokenParsed=m(A)}else{delete w.refreshToken;delete w.refreshTokenParsed}if(E){w.idToken=E;w.idTokenParsed=m(E)}else{delete w.idToken;delete w.idTokenParsed}}function m(y){y=y.split(".")[1];y=y.replace("/-/g","+");y=y.replace("/_/g","/");switch(y.length%4){case 0:break;case 2:y+="==";break;case 3:y+="=";break;default:throw"Invalid token"}y=(y+"===").slice(0,y.length+(y.length%4));y=y.replace(/-/g,"+").replace(/_/g,"/");y=decodeURIComponent(escape(atob(y)));y=JSON.parse(y);return y}function e(){var B=[];var y="0123456789abcdef";for(var z=0;z<36;z++){B[z]=y.substr(Math.floor(Math.random()*16),1)}B[14]="4";B[19]=y.substr((B[19]&3)|8,1);B[8]=B[13]=B[18]=B[23]="-";var A=B.join("");return A}w.callback_id=0;function n(){var y="<id: "+(w.callback_id++)+(Math.random())+">";return y}function f(A){var y=new h(A,w.responseMode).parseUri();var B=q.getItem("oauthState");var z=B&&JSON.parse(B);if(z&&(y.code||y.error||y.access_token||y.id_token)&&y.state&&y.state==z.state){q.removeItem("oauthState");y.redirectUri=z.redirectUri;y.storedNonce=z.nonce;if(y.fragment){y.newUrl+="#"+y.fragment}return y}}function d(){var y={setSuccess:function(z){y.success=true;y.result=z;if(y.successCallback){y.successCallback(z)}},setError:function(z){y.error=true;y.result=z;if(y.errorCallback){y.errorCallback(z)}},promise:{success:function(z){if(y.success){z(y.result)}else{if(!y.error){y.successCallback=z}}return y.promise},error:function(z){if(y.error){z(y.result)}else{if(!y.success){y.errorCallback=z}}return y.promise}}};return y}function v(){var C=d();if(!r.enable){C.setSuccess();return C.promise}if(r.iframe){C.setSuccess();return C.promise}var A=document.createElement("iframe");r.iframe=A;A.onload=function(){var D=k();if(D.charAt(0)==="/"){r.iframeOrigin=s()}else{r.iframeOrigin=D.substring(0,D.indexOf("/",8))}C.setSuccess();setTimeout(y,r.interval*1000)};var B=k()+"/protocol/openid-connect/login-status-iframe.html?client_id="+encodeURIComponent(w.clientId)+"&origin="+s();A.setAttribute("src",B);A.style.display="none";document.body.appendChild(A);var z=function(D){if(D.origin!==r.iframeOrigin){return}var E=JSON.parse(D.data);var F=r.callbackMap[E.callbackId];delete r.callbackMap[E.callbackId];if((!w.sessionId||w.sessionId==E.session)&&E.loggedIn){F.setSuccess()}else{w.clearToken();F.setError()}};b.addEventListener("message",z,false);var y=function(){i();if(w.token){setTimeout(y,r.interval*1000)}};return C.promise}function i(){var A=d();if(r.iframe&&r.iframeOrigin){var z={};z.callbackId=n();r.callbackMap[z.callbackId]=A;var y=r.iframeOrigin;r.iframe.contentWindow.postMessage(JSON.stringify(z),y)}else{A.setSuccess()}return A.promise}function t(y){if(!y||y=="default"){return{login:function(z){b.location.href=w.createLoginUrl(z);return d().promise},logout:function(z){b.location.href=w.createLogoutUrl(z);return d().promise},register:function(z){b.location.href=w.createRegisterUrl(z);return d().promise},accountManagement:function(){b.location.href=w.createAccountUrl();return d().promise},redirectUri:function(z,A){if(arguments.length==1){A=true}if(z&&z.redirectUri){return z.redirectUri}else{if(w.redirectUri){return w.redirectUri}else{var B=location.href;if(location.hash&&A){B=B.substring(0,location.href.indexOf("#"));B+=(B.indexOf("?")==-1?"?":"&")+"redirect_fragment="+encodeURIComponent(location.hash.substring(1))}return B}}}}}if(y=="cordova"){r.enable=false;return{login:function(z){var E=d();var D="location=no";if(z&&z.prompt=="none"){D+=",hidden=yes"}var C=w.createLoginUrl(z);var B=b.open(C,"_blank",D);var A=false;B.addEventListener("loadstart",function(F){if(F.url.indexOf("http://localhost")==0){var G=f(F.url);j(G,E);B.close();A=true}});B.addEventListener("loaderror",function(F){if(!A){if(F.url.indexOf("http://localhost")==0){var G=f(F.url);j(G,E);B.close();A=true}else{E.setError();B.close()}}});return E.promise},logout:function(B){var D=d();var z=w.createLogoutUrl(B);var C=b.open(z,"_blank","location=no,hidden=yes");var A;C.addEventListener("loadstart",function(E){if(E.url.indexOf("http://localhost")==0){C.close()}});C.addEventListener("loaderror",function(E){if(E.url.indexOf("http://localhost")==0){C.close()}else{A=true;C.close()}});C.addEventListener("exit",function(E){if(A){D.setError()}else{w.clearToken();D.setSuccess()}});return D.promise},register:function(){var z=w.createRegisterUrl();var A=b.open(z,"_blank","location=no");A.addEventListener("loadstart",function(B){if(B.url.indexOf("http://localhost")==0){A.close()}})},accountManagement:function(){var z=w.createAccountUrl();var A=b.open(z,"_blank","location=no");A.addEventListener("loadstart",function(B){if(B.url.indexOf("http://localhost")==0){A.close()}})},redirectUri:function(z){return"http://localhost"}}}throw"invalid adapter type: "+y}var u=function(){if(!(this instanceof u)){return new u()}var C=this;var y=function(){if(typeof localStorage==="undefined"){return true}try{var D="@@leadsid-session-storage/test";localStorage.setItem(D,"test");localStorage.removeItem(D);return false}catch(E){return true}};C.setItem=function(D,E){if(y()){A(D,E,B(5))}else{localStorage.setItem(D,E)}};C.getItem=function(D){if(y()){return z(D)}return localStorage.getItem(D)};C.removeItem=function(D){if(typeof localStorage!=="undefined"){try{localStorage.removeItem(D)}catch(E){}}A(D,"",B(-100))};var B=function(D){var E=new Date();E.setTime(E.getTime()+(D*60*1000));return E};var z=function(G){var E=G+"=";var D=document.cookie.split(";");for(var F=0;F<D.length;F++){var H=D[F];while(H.charAt(0)==" "){H=H.substring(1)}if(H.indexOf(E)==0){return H.substring(E.length,H.length)}}return""};var A=function(F,G,D){var E=F+"="+G+"; expires="+D.toUTCString()+"; ";document.cookie=E}};var h=function(y,B){if(!(this instanceof h)){return new h(y,B)}var D=this;var z=function(){var H=null;var I=null;var G=null;var E=y.indexOf("?");var F=y.indexOf("#",E+1);if(E==-1&&F==-1){H=y}else{if(E!=-1){H=y.substring(0,E);I=y.substring(E+1);if(F!=-1){F=I.indexOf("#");G=I.substring(F+1);I=I.substring(0,F)}}else{H=y.substring(0,F);G=y.substring(F+1)}}return{baseUri:H,queryString:I,fragmentString:G}};var A=function(K){var E={};var J=K.split("&");for(var F=0;F<J.length;F++){var H=J[F].split("=");var G=decodeURIComponent(H[0]);var I=decodeURIComponent(H[1]);E[G]=I}return E};var C=function(H,I,E){var G=["code","error","state"];for(var F=0;F<G.length;F++){if(H===G[F]){E[H]=I;return true}}return false};D.parseUri=function(){var I=z();var G={};if(I.queryString){G=A(I.queryString)}var E={newUrl:I.baseUri};for(var H in G){switch(H){case"redirect_fragment":E.fragment=G[H];break;case"prompt":E.prompt=G[H];break;default:if(B!="query"||!C(H,G[H],E)){E.newUrl+=(E.newUrl.indexOf("?")==-1?"?":"&")+H+"="+G[H]}break}}if(B==="fragment"){var F={};if(I.fragmentString){F=A(I.fragmentString)}for(var H in F){E[H]=F[H]}}return E}}};if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=a}else{b.LeadsID=a;if(typeof define==="function"&&define.amd){define("leadsid",[],function(){return a})}}})(window);
